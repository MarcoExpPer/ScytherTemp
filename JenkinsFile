def N_COMMITS = 0

pipeline {
    agent {
		node {
        label 'master'
        customWorkspace "C:\\JenkinsWorkspaces\\${PROJECT_NAME}"
    }}
    stages {
        stage('Check changes') { 
            steps {
				script{
					N_COMMITS = currentBuild.changeSets.size(); 
					echo "Amount of commits -> ${N_COMMITS}"
					echo "${WORKSPACE}"
					
					if(params.FORCE_BUILD == true){
						N_COMMITS = 1;
						echo "Forcing build"
					}
				}
            }
        }
		stage('Build and compile'){
			steps{
				script{
					if(N_COMMITS > 0){
						echo "Send Building and compiling to -> ${env.DISCORD_HOOK}"
						echo "Building and compiling"
						
						/*
						bat "\"${UE_PATH}\\Engine\\Binaries\\DotNET\\UnrealBuildTool.exe\" -projectfiles -project=\"${WORKSPACE}\\${PROJECT_NAME}.uproject\" -game -rocket -progress"
						bat "\"${UE_PATH}/Engine/Binaries/DotNET/UnrealBuildTool.exe\" ${PROJECT_NAME} development Win64 -project=\"${WORKSPACE}\\${PROJECT_NAME}.uproject\" -rocket -editorrecompile -progress -noubtmakefiles -NoHotReloadFromIDE -2019"
						
						bat "if not exist \"${WORKSPACE}/Builds/" mkdir \"${WORKSPACE}/Builds\""
							
						bat "\"${UE_PATH}\\Engine\\Build\\BatchFiles\\RunUAT.bat\" BuildCookRun -project=\"${WORKSPACE}\\${PROJECT_NAME}.uproject\" -noP4 -platform=Win64 -clientconfig=Development -cook -allmaps -build -stage %USE_PAK% -archive -archivedirectory=\"${WORKSPACE}/Builds\""
*///
					}
				}
			}
		}
		stage('Automatic testing'){
			steps{
				script{
					if(N_COMMITS > 0){
						echo "Send Doing tests to -> ${env.DISCORD_HOOK}"
						echo "Doing tests"
						
						try{
							bat "\"${UE_PATH}Engine\\Binaries\\Win64\\UE4Editor-Cmd.exe\" ${WORKSPACE}\\${PROJECT_NAME}.uproject -nosplash -unattended -nocontentbrowser -nosound -nopause -nullrhi -ExecCmds=\"Automation RunTests Slate.FastPath.InvalidationWidgetList.AddBuildRemove\" -testexit=\"Automation Test Queue Empty\" -log -log=RunTests.log -ReportOutputPath=\"${WORKSPACE}\\Saved\\AutomationTestResults\\UnrealUnitTests\"" 
						}catch( Exception e){
							echo "Error while doing UE automatic UnitTest -> ${e.getMessage()}"
						}

						try{
							bat "\"${UE_PATH}Engine\\Binaries\\Win64\\UE4Editor-Cmd.exe\" ${WORKSPACE}\\${PROJECT_NAME}.uproject -nosplash -unattended -nocontentbrowser -nosound -nopause -nullrhi -ExecCmds=\"Automation RunTests Project.UnitTest.HitAngleTest\" -testexit=\"Automation Test Queue Empty\" -log -log=RunTests.log -ReportOutputPath=\"${WORKSPACE}\\Saved\\AutomationTestResults\\ProjectUnitTests\"" 
						}catch( Exception e){
							echo "Error while doing Project automatic UnitTest -> ${e.getMessage()}"
						}
					}
				}
			}
		}
    }
	post{
        success{
            script{
               	if(N_COMMITS > 0){
					echo "Send success to -> ${env.DISCORD_HOOK}"
				}else{
					echo "No changes"
				}
            }
        }
        failure {
            script{
               	if(N_COMMITS > 0){
					echo "Send failure to -> ${env.DISCORD_HOOK}"
				}else{
					echo "Send failure when no new commits to -> ${env.DISCORD_HOOK}"
				}
            }
        }
    }
}